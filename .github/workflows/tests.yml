name: Tests and CI

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch: # Permite ejecución manual

jobs:
    test:
        name: Run Tests
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: [3.8, 3.9, 3.10, 3.11]
            fail-fast: false

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Set up Java (required for PySpark)
              uses: actions/setup-java@v3
              with:
                  distribution: "temurin"
                  java-version: "11"

            - name: Cache pip packages
              uses: actions/cache@v3
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install -r requirements-dev.txt

            - name: Run linting
              run: |
                  flake8 src tests --max-line-length=100 --exclude=__pycache__ --count --statistics
              continue-on-error: true

            - name: Check code formatting
              run: |
                  black src tests --check --line-length=100
              continue-on-error: true

            - name: Run unit tests
              run: |
                  pytest tests/ -v -m "not slow" --cov=src --cov-report=xml --cov-report=term-missing

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false

            - name: Run integration tests
              run: |
                  pytest tests/ -v -m "integration or slow" --timeout=300
              continue-on-error: true

            - name: Generate test report
              if: always()
              run: |
                  pytest tests/ --html=report.html --self-contained-html
              continue-on-error: true

            - name: Upload test report
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: test-report-${{ matrix.python-version }}
                  path: report.html

    lint:
        name: Code Quality Checks
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install dependencies
              run: |
                  pip install flake8 pylint black mypy

            - name: Run flake8
              run: flake8 src tests --max-line-length=100 --statistics
              continue-on-error: true

            - name: Run pylint
              run: pylint src --disable=C0111,R0903
              continue-on-error: true

            - name: Run black check
              run: black src tests --check --line-length=100
              continue-on-error: true

            - name: Run mypy
              run: mypy src --ignore-missing-imports
              continue-on-error: true

    security:
        name: Security Scan
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install bandit
              run: pip install bandit[toml]

            - name: Run security scan
              run: bandit -r src -f json -o bandit-report.json
              continue-on-error: true

            - name: Upload security report
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: security-report
                  path: bandit-report.json

    build-status:
        name: Build Status
        runs-on: ubuntu-latest
        needs: [test, lint]
        if: always()

        steps:
            - name: Check build status
              run: |
                  if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.lint.result }}" == "success" ]; then
                    echo "✅ All checks passed!"
                    exit 0
                  else
                    echo "❌ Some checks failed"
                    exit 1
                  fi
